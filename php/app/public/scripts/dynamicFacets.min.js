var dynamicFacets={displayConcept:null,numFound:null,keywordFiltersCount:null,updateFacetRoute:null,maxFacetDisplay:null,tables:null,domainTable:null,studySerieTable:null,studyTable:null,decadeTable:null,conceptTable:null,queryFilterTable:null,translate:null,searchQuestion:null,searchModalities:null,searchVariable:null,init:function(a){this.displayConcept=a.displayConcept;this.numFound=a.numFound;this.keywordFiltersCount=a.keywordFiltersCount;this.updateFacetRoute=a.updateFacetRoute;this.maxFacetDisplay=a.maxFacetDisplay;this.searchQuestion=a.searchQuestion;this.searchModalities=a.searchModalities;this.searchVariable=a.searchVariable;this.translate={kwFs1:a.translate.kwFs1,kwFs2:a.translate.kwFs2,kwFs3:a.translate.kwFs3,keywordFiltersEnter:a.translate.keywordFiltersEnter};if(this.numFound>0){dynamicFacets._initDomainTable(a);dynamicFacets._initStudySerieTable(a);dynamicFacets._initStudyTable(a);dynamicFacets._initDecadeTable(a);dynamicFacets._initQueryFilterTable(a);dynamicFacets.tables=[dynamicFacets.domainTable,dynamicFacets.studySerieTable,dynamicFacets.studyTable,dynamicFacets.decadeTable,dynamicFacets.queryFilterTable];if(dynamicFacets.displayConcept){dynamicFacets._initConceptTable(a);dynamicFacets.tables.push(dynamicFacets.conceptTable)}dynamicFacets.updateFacets()}this._addSubmitListener();this._addTogglersListener();this._addQueryFilterAddListener();this._makeSortable();this._addFacetsListener();this._addFacetsResetListener();this._addQueryFilterTargetListener();this._addQueryFilterInputListener();this._preventFFAC();return this},_addQueryFilterInputListener:function(){$("#queryFilterInput").focus(function(){if($(this).val()==dynamicFacets.translate.keywordFiltersEnter){$(this).val("")}}).val(dynamicFacets.translate.keywordFiltersEnter)},_initDomainTable:function(a){this.domainTable=$("#domainFilters").dataTable({sDom:'lf<"clear">rtip<"clear">',aoColumns:[{sSortDataType:"dom-checkbox"},{sSortDataType:"text"},{sSortDataType:"number"},{bVisible:false}],oLanguage:{sLengthMenu:a.translate.table._common.sLengthMenu,sZeroRecords:a.translate.table.domain.sZeroRecords,sInfo:a.translate.table.domain.sInfo,sInfoEmpty:a.translate.table.domain.sInfoEmpty,sInfoFiltered:a.translate.table.domain.sInfoFiltered,sSearch:a.translate.table._common.sSearch,oPaginate:a.translate.table._common.oPaginate},aaSorting:[[0,"desc"],[2,"desc"]],sPaginationType:"input",fnInitComplete:function(b){if(b.fnRecordsDisplay()<=dynamicFacets.maxFacetDisplay){$("#domainFilters_length").hide();$("#domainFilters_filter").hide();$("#domainFilters_paginate").hide();$("#domainFilters_info").hide()}},aLengthMenu:[5,10,25],iDisplayLength:dynamicFacets.maxFacetDisplay,fnRowCallback:function(e,d,c,b){return e}})},_initStudySerieTable:function(a){this.studySerieTable=$("#studySerieFilters").dataTable({sDom:'lf<"clear">rtip<"clear">',aoColumns:[{sSortDataType:"dom-checkbox"},{sSortDataType:"text"},{sSortDataType:"number"},{bVisible:false}],oLanguage:{sLengthMenu:a.translate.table._common.sLengthMenu,sZeroRecords:a.translate.table.studySerie.sZeroRecords,sInfo:a.translate.table.studySerie.sInfo,sInfoEmpty:a.translate.table.studySerie.sInfoEmpty,sInfoFiltered:a.translate.table.studySerie.sInfoFiltered,sSearch:a.translate.table._common.sSearch,oPaginate:a.translate.table._common.oPaginate},aaSorting:[[0,"desc"],[2,"desc"]],sPaginationType:"input",fnInitComplete:function(b){if(b.fnRecordsDisplay()<=dynamicFacets.maxFacetDisplay){$("#studySerieFilters_length").hide();$("#studySerieFilters_filter").hide();$("#studySerieFilters_paginate").hide();$("#studySerieFilters_info").hide()}},aLengthMenu:[5,10,25],iDisplayLength:dynamicFacets.maxFacetDisplay,fnRowCallback:function(e,d,c,b){$(e).css("display","");return e}})},_initStudyTable:function(a){this.studyTable=$("#studyFilters").dataTable({sDom:'lf<"clear">rtip<"clear">',aoColumns:[{sSortDataType:"dom-checkbox"},{sSortDataType:"text"},{sSortDataType:"number"},{bVisible:false}],oLanguage:{sLengthMenu:a.translate.table._common.sLengthMenu,sZeroRecords:a.translate.table.study.sZeroRecords,sInfo:a.translate.table.study.sInfo,sInfoEmpty:a.translate.table.study.sInfoEmpty,sInfoFiltered:a.translate.table.study.sInfoFiltered,sSearch:a.translate.table._common.sSearch,oPaginate:a.translate.table._common.oPaginate},aaSorting:[[0,"desc"],[2,"desc"]],sPaginationType:"input",fnInitComplete:function(b){if(b.fnRecordsDisplay()<=dynamicFacets.maxFacetDisplay){$("#studyFilters_length").hide();$("#studyFilters_filter").hide();$("#studyFilters_paginate").hide();$("#studyFilters_info").hide()}},aLengthMenu:[5,10,25],iDisplayLength:dynamicFacets.maxFacetDisplay,fnRowCallback:function(e,d,c,b){$(e).css("display","");return e}})},_initDecadeTable:function(a){this.decadeTable=$("#decadeFilters").dataTable({sDom:'lf<"clear">rtip<"clear">',aoColumns:[{sSortDataType:"dom-checkbox"},{sSortDataType:"text"},{sSortDataType:"number"}],oLanguage:{sLengthMenu:a.translate.table._common.sLengthMenu,sZeroRecords:a.translate.table.decade.sZeroRecords,sInfo:a.translate.table.decade.sInfo,sInfoEmpty:a.translate.table.decade.sInfoEmpty,sInfoFiltered:a.translate.table.decade.sInfoFiltered,sSearch:a.translate.table._common.sSearch,oPaginate:a.translate.table._common.oPaginate},aaSorting:[[0,"desc"],[1,"desc"]],sPaginationType:"input",fnInitComplete:function(b){if(b.fnRecordsDisplay()<=dynamicFacets.maxFacetDisplay){$("#decadeFilters_length").hide();$("#decadeFilters_filter").hide();$("#decadeFilters_paginate").hide();$("#decadeFilters_info").hide()}},aLengthMenu:[5,10,25],iDisplayLength:dynamicFacets.maxFacetDisplay,fnRowCallback:function(e,d,c,b){$(e).css("display","");return e}})},_initConceptTable:function(a){this.conceptTable=$("#conceptFilters").dataTable({sDom:'lf<"clear">rtip<"clear">',aoColumns:[{sSortDataType:"dom-checkbox"},{sSortDataType:"text"},{sSortDataType:"number"},{bVisible:false}],oLanguage:{sLengthMenu:a.translate.table._common.sLengthMenu,sZeroRecords:a.translate.table.decade.sZeroRecords,sInfo:a.translate.table.decade.sInfo,sInfoEmpty:a.translate.table.decade.sInfoEmpty,sInfoFiltered:a.translate.table.decade.sInfoFiltered,sSearch:a.translate.table._common.sSearch,oPaginate:a.translate.table._common.oPaginate},aaSorting:[[0,"desc"],[2,"desc"]],sPaginationType:"input",fnInitComplete:function(b){if(b.fnRecordsDisplay()<=dynamicFacets.maxFacetDisplay){$("#conceptFilters_length").hide();$("#conceptFilters_filter").hide();$("#conceptFilters_paginate").hide();$("#conceptFilters_info").hide()}},aLengthMenu:[5,10,25],iDisplayLength:dynamicFacets.maxFacetDisplay,fnRowCallback:function(e,d,c,b){$(e).css("display","");return e}})},_initQueryFilterTable:function(a){this.queryFilterTable=$("#queryFilters").dataTable({sDom:'lf<"clear">rtip<"clear">',aoColumns:[{sSortDataType:"dom-checkbox"},{sSortDataType:"text"},{sSortDataType:"dom-checkbox"},{sSortDataType:"dom-checkbox"},{sSortDataType:"dom-checkbox"},{sSortDataType:"number"}],oLanguage:{sLengthMenu:a.translate.table._common.sLengthMenu,sZeroRecords:a.translate.table.queryFilter.sZeroRecords,sInfo:a.translate.table.queryFilter.sInfo,sInfoEmpty:a.translate.table.queryFilter.sInfoEmpty,sInfoFiltered:a.translate.table.queryFilter.sInfoFiltered,sSearch:a.translate.table._common.sSearch,oPaginate:a.translate.table._common.oPaginate},aaSorting:[[0,"desc"],[5,"desc"]],sPaginationType:"input",fnInitComplete:function(b){if(b.fnRecordsDisplay()<=dynamicFacets.maxFacetDisplay){$("#queryFilters_length").hide();$("#queryFilters_filter").hide();$("#queryFilters_paginate").hide();$("#queryFilters_info").hide()}},aLengthMenu:[5,10,25],iDisplayLength:dynamicFacets.maxFacetDisplay,fnRowCallback:function(e,d,c,b){$(e).css("display","");return e}})},_makeSortable:function(){$("#sortable").sortable({axis:"y",cursor:"move",handle:"div.facetHeader",stop:function(b,c){var a=0;$(this).find("li").each(function(){$.cookie("settings["+$(this).attr("id")+"Position]",a,{expires:10000,path:"/"});a++})},tolerance:"pointer",placeholder:"sortableLandmark",start:function(a,b){$(".sortableLandmark").height(b.item.height())}})},updateFacets:function(k){var c=[],f=[],j=[],b=[],e=[],h=[];var a=this.updateFacetRoute,d="";var i;var g=0;$(this.domainTable.fnGetNodes()).find(("input.domainFilter:checked")).each(function(){c.push($(this).val());g++});if(this.displayConcept){$(this.conceptTable.fnGetNodes()).find("input.conceptFilter:checked").each(function(){f.push($(this).val());g++})}$(this.studySerieTable.fnGetNodes()).find("input.studySerieFilter:checked").each(function(){j.push($(this).val());g++});$(this.decadeTable.fnGetNodes()).find("input.decadeFilter:checked").each(function(){b.push($(this).val());g++});$(this.studyTable.fnGetNodes()).find("input.studyFilter:checked").each(function(){h.push($(this).val());g++});$(this.queryFilterTable.fnGetNodes()).find("input.queryFilter").each(function(){var n=$(this).val(),l=$(this).closest("tr"),m=0;m+=l.find("input.qCb").attr("checked")?dynamicFacets.searchQuestion:0;m+=l.find("input.cCb").attr("checked")?dynamicFacets.searchModalities:0;m+=l.find("input.vCb").attr("checked")?dynamicFacets.searchVariable:0;if(m!==0){n+=m;n+=($(this).attr("checked")&&++g)?"1":"0";e.push(encodeURI(n))}});if(c.length>0){d+="&domainFilters[]=";d+=c.join("&domainFilters[]=")}if(f.length>0){d+="&conceptFilters[]=";d+=f.join("&conceptFilters[]=")}if(j.length>0){d+="&studySerieFilters[]=";d+=j.join("&studySerieFilters[]=")}if(b.length>0){d+="&decadeFilters[]=";d+=b.join("&decadeFilters[]=")}if(e.length>0){d+="&queryFilters2[]=";d+=e.join("&queryFilters2[]=")}if(h.length>0){d+="&studyFilters[]=";d+=h.join("&studyFilters[]=")}if(g===0){$("span.facetReset").css("display","none")}else{$("span.facetReset").css("display","inline-block")}a=a+encodeURI(d);$.getJSON(a,function(m){if(k&&m.numFound===0&&(k.hasClass("queryFilter")||k.hasClass("qfTarget"))){var l;if(k.hasClass("qfTarget")){l=k.closest("tr").find("input.queryFilter")}else{l=k}l.removeAttr("checked");dynamicFacets.updateFacets(k);return}dynamicFacets.updateTable(m.studies,dynamicFacets.studyTable,"study",!(k&&k.hasClass("studyFilter")));dynamicFacets.updateTable(m.domains,dynamicFacets.domainTable,"domain",!(k&&k.hasClass("domainFilter")));dynamicFacets.updateTable(m.studySeries,dynamicFacets.studySerieTable,"studySerie",!(k&&k.hasClass("studySerieFilter")));dynamicFacets.updateTable(m.decades,dynamicFacets.decadeTable,"decade",!(k&&k.hasClass("decadeFilter")));if(dynamicFacets.displayConcept){dynamicFacets.updateTable(m.concepts,dynamicFacets.conceptTable,"concept",!(k&&k.hasClass("conceptFilter")))}dynamicFacets.updateQueryFilterTable(m.keywords,!(k&&(k.hasClass("queryFilter")||k.hasClass("qfTarget"))),k);if(k&&!k.hasClass("studyFilter")){var n="#studyFilters td.count";if(!k.hasClass("conceptFilter")){n+=", #conceptFilters td.count"}if(!k.hasClass("queryFilter")){n+=", #queryFilters td.count"}if(!k.hasClass("studySerieFilter")){n+=", #studySerieFilters td.count";if(!k.hasClass("domainFilter")){n+=", #domainFilters td.count";if(!k.hasClass("decadeFilter")){n+=", #decadeFilters td.count"}}}$(n).effect("pulsate",{times:1},150)}})},updateTable:function(c,e,d,f){var b=$(e.fnGetNodes()),a=b.length;b.each(function(m,o){var g,l,n=$(this),h=n.find("td").first(),j=h.find("input"),p=false;for(var k=0;k<c.length;k+=2){g=c[k];l=c[k+1];if((d+"CheckBox_"+g)==j.attr("id")){p=true;break}}if(p){if(n.hasClass("disabled")){n.removeClass("disabled")}j.removeAttr("disabled")}else{l=0;if(!n.hasClass("disabled")){n.addClass("disabled")}j.removeAttr("checked");j.attr("disabled","true")}if($.browser.msie&&parseInt($.browser.version,10)==6){e.fnUpdate(h.html(),n[0],0,false,false)}e.fnUpdate(l,n[0],2,false,m==(a-1))});e.fnDraw(f)},updateQueryFilterTable:function(e,g,c){var b=$(this.queryFilterTable.fnGetNodes()),a=b.length,d=false,f=false;if(c&&c.hasClass("qfTarget")){d=c.closest("tr").find("input.queryFilter").attr("id")}b.each(function(o,r){var j,n,q=$(this),l=q.find("td").first(),m=l.find("input"),u=false,t=q.find("input.qCb"),s=q.find("input.cCb"),i=q.find("input.vCb"),p=0;p+=t.attr("checked")?dynamicFacets.searchQuestion:0;p+=s.attr("checked")?dynamicFacets.searchModalities:0;p+=i.attr("checked")?dynamicFacets.searchVariable:0;var h=$(this).closest("div"),k=m.val(),n=e[k+p];if(n>0){if(q.hasClass("disabled")){q.removeClass("disabled");m.removeAttr("disabled")}if(d===m.attr("id")){if(!m.attr("checked")){f=true}m.attr("checked","checked")}}else{if(!q.hasClass("disabled")){q.addClass("disabled")}m.removeAttr("checked");m.attr("disabled","true")}if(n===undefined){n="-"}if($.browser.msie&&parseInt($.browser.version,10)==6){dynamicFacets.queryFilterTable.fnUpdate(l.html(),q[0],0,false,false)}dynamicFacets.queryFilterTable.fnUpdate(n,q[0],5,false,false)});this.queryFilterTable.fnDraw(g);if(f){this.updateFacets(c)}},addQueryFilter:function(){var h=$("#queryFilterInput").val(),f,e,b,a,d,c,g;$("#queryFilterInput").val("");h=jQuery.trim(h);if(h===""||!luceneQueryValidator.checkQuery(h)){return}_val=h.replace(/(\S)\-(\S)/,"$1 $2");_val=$.normalize(_val);f='<input id="queryCheckbox_'+this.keywordFiltersCount+'" class="queryFilter resultFilter" name="queryFilters2[]" value="" type="checkbox" checked="checked">';d='<label for="queryCheckbox_'+this.keywordFiltersCount+'">'+h+"</label>";e='<input class="qfTarget qCb" name="qQueryFilter_'+this.keywordFiltersCount+'" checked="checked" value="" type="checkbox">';b='<input class="qfTarget cCb" name="cQueryFilter_'+this.keywordFiltersCount+'" checked="checked" value="" type="checkbox">';a='<input class="qfTarget vCb" name="vQueryFilter_'+this.keywordFiltersCount+'" checked="checked" value="" type="checkbox">';c=this.queryFilterTable.fnAddData([f,d,e,b,a,""],false);g=this.queryFilterTable.fnGetNodes(c);g=$(g);g.find("td").eq(0).addClass("checkbox").find("input").val(_val);g.find("td").eq(1).addClass("title");g.find("td").eq(2).addClass("checkbox");g.find("td").eq(3).addClass("checkbox");g.find("td").eq(4).addClass("checkbox");g.find("td").eq(5).addClass("count");this.queryFilterTable.fnDraw(false);this.keywordFiltersCount++;if(this.keywordFiltersCount>dynamicFacets.maxFacetDisplay){$("#queryFilters_length").show();$("#queryFilters_filter").show();$("#queryFilters_paginate").show();$("#queryFilters_info").show()}this.updateFacets(g.find("input.queryFilter"));$("#queryFilterInput").val(this.translate.keywordFiltersEnter).blur()},resetFacetForm:function(){for(var a=0;a<this.tables.length;a++){$(this.tables[a].fnGetNodes()).find("input:checked").each(function(){$(this).removeAttr("checked")})}},_addSubmitListener:function(){$("#facetFilter").submit(function(){$("#facetFilter div.toggled").hide();for(var a=0;a<dynamicFacets.tables.length;a++){dynamicFacets.tables[a].fnDestroy()}$("#queryFilters tbody tr").each(function(){var c=0;var b=$(this).find("input.queryFilter");c+=$(this).find("input.qCb:checked").attr("checked")?dynamicFacets.searchQuestion:0;c+=$(this).find("input.cCb:checked").attr("checked")?dynamicFacets.searchModalities:0;c+=$(this).find("input.vCb:checked").attr("checked")?dynamicFacets.searchVariable:0;b.val(b.val()+c)})})},_addTogglersListener:function(){$("span.toggler").click(function(a){if(!$(this).hasClass("down")){$(this).addClass("down");$.cookie("settings["+$(this).closest("li").attr("id")+"Display]","1",{expires:10000,path:"/"})}else{$(this).removeClass("down");$.cookie("settings["+$(this).closest("li").attr("id")+"Display]","0",{expires:10000,path:"/"})}a.stopPropagation();var b=$(this).closest("div.facetHeader").next();b.toggle()})},_addQueryFilterAddListener:function(){$("#facetFilter").bind("keypress",function(a){if(a.keyCode==13){return false}});$("#queryFilterInput").keyup(function(a){if(a.keyCode==13){$("#firefoxFix").focus();dynamicFacets.addQueryFilter()}});$("#queryFilterButton").click(function(a){dynamicFacets.addQueryFilter()})},_addFacetsListener:function(){$("input.studyFilter, input.domainFilter, input.conceptFilter, input.studySerieFilter, input.decadeFilter, input.queryFilter").livequery("change",function(){dynamicFacets.updateFacets($(this))})},_addFacetsResetListener:function(){$("span.facetReset").click(function(a){dynamicFacets.resetFacetForm();dynamicFacets.updateFacets()})},_addQueryFilterTargetListener:function(){$("input.qfTarget").live("click",function(a){dynamicFacets.updateFacets($(this))})},_preventFFAC:function(){if($.browser.mozilla){$("#facetFilter").attr("autocomplete","off")}}};